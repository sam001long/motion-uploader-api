<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Motion Data Uploader</title>
  <style>
    :root { --bg:#0b1020; --card:#11162a; --muted:#8fa3c7; --accent:#7cc7ff; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans TC", sans-serif; background:var(--bg); color:#e6eefc; }
    .wrap { max-width:980px; margin:40px auto; padding:0 16px; }
    .card { background:var(--card); border:1px solid #24304f; border-radius:18px; padding:20px; box-shadow:0 10px 30px rgba(0,0,0,.25); }
    h1 { margin:0 0 8px; font-size:28px; letter-spacing:.3px }
    p.muted { color: var(--muted); margin-top:6px }
    .row { display:flex; gap:16px; align-items:center; flex-wrap:wrap; }
    .drop { flex:1; min-height:140px; border:2px dashed #2e3d64; border-radius:16px; display:flex; align-items:center; justify-content:center; text-align:center; padding:18px; cursor:pointer; transition:.2s border-color,.2s background; }
    .drop.hover { border-color: var(--accent); background: rgba(124,199,255,.06); }
    .btn { background:linear-gradient(180deg,#1e3a8a,#0f245c); color:white; border:1px solid #224185; padding:10px 14px; border-radius:10px; cursor:pointer; font-weight:600; }
    .btn.secondary { background:#0f245c; }
    .btn:disabled { opacity:.5; cursor:not-allowed }
    .grid { margin-top:16px; display:grid; grid-template-columns: 1fr; gap:10px; }
    .item { background:#0b1329; border:1px solid #1f2a4a; border-radius:12px; padding:10px 12px; }
    .item .name { font-weight:600 }
    .item .bar { height:8px; background:#1c2544; border-radius:6px; margin-top:8px; overflow:hidden }
    .item .bar > i { display:block; height:100%; width:0%; background: var(--accent); transition: width .3s }
    .small { font-size:12px; color: var(--muted) }
    .ok { color:#9fffb2 }
    .err { color:#ff9f9f }
    .cfg { margin-top:10px; }
    .cfg input { background:#091126; color:#e6eefc; border:1px solid #223058; border-radius:8px; padding:8px 10px; width:100% }
    .footer { margin-top:16px; color: var(--muted); font-size:12px }
    a { color: var(--accent); text-decoration: none }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Motion Data Uploader</h1>
      <p class="muted">大量上傳 CSV / XLSX / JSON，後端自動清洗與入庫。遇到新格式只要在伺服器 <code>ingest_config.yaml</code> 加規則即可。</p>

      <div class="cfg">
        <label class="small">API 位址（通常是你的後端，例如 https://your-app.onrender.com）</label>
        <input id="apiBase" placeholder="https://localhost:8787" />
      </div>

      <div class="row" style="margin-top:14px">
        <div id="drop" class="drop">
          <div>
            <div style="font-weight:700; font-size:16px">拖放檔案到這裡，或點擊選擇</div>
            <div class="small">支援 .csv、.tsv、.xlsx、.xls、.json（可多選）</div>
          </div>
          <input id="file" type="file" multiple style="display:none" accept=".csv,.tsv,.xlsx,.xls,.json" />
        </div>
        <button id="send" class="btn" disabled>上傳並匯入</button>
        <button id="dlData" class="btn secondary">下載整理後 CSV</button>
        <button id="dlSources" class="btn secondary">下載來源清單</button>
      </div>

      <div id="list" class="grid"></div>

      <div class="footer">安全性：上線前請在伺服器設定 <code>API_KEY</code>，此頁已預留自訂標頭。</div>
    </div>
  </div>

  <script>
    // === 可調整：預設 API（初次載入會寫到輸入框） ===
    const DEFAULT_API_BASE = "https://motion-uploader-api-1.onrender.com"; // 上線請改成你的後端網址
    const API_KEY = 'sam-db-xyz'; // 若伺服器未設 API_KEY，可留空字串

    const apiBaseInput = document.getElementById('apiBase');
    apiBaseInput.value = localStorage.getItem('apiBase') || DEFAULT_API_BASE;
    apiBaseInput.addEventListener('change', () => localStorage.setItem('apiBase', apiBaseInput.value.trim()));

    const drop = document.getElementById('drop');
    const file = document.getElementById('file');
    const send = document.getElementById('send');
    const list = document.getElementById('list');
    const dlData = document.getElementById('dlData');
    const dlSources = document.getElementById('dlSources');

    let files = [];

    const renderList = () => {
      list.innerHTML = '';
      files.forEach(f => {
        const el = document.createElement('div');
        el.className = 'item';
        el.innerHTML = `
          <div class="name">${f.name} <span class="small">(${(f.size/1024).toFixed(1)} KB)</span></div>
          <div class="bar"><i style="width:${f._p||0}%"></i></div>
          <div class="small" id="m_${f._id}">待上傳</div>
        `;
        list.appendChild(el);
      });
      send.disabled = files.length === 0;
    };

    const pick = () => file.click();
    drop.addEventListener('click', pick);
    drop.addEventListener('dragover', e => { e.preventDefault(); drop.classList.add('hover'); });
    drop.addEventListener('dragleave', () => drop.classList.remove('hover'));
    drop.addEventListener('drop', e => {
      e.preventDefault(); drop.classList.remove('hover');
      files = [...files, ...Array.from(e.dataTransfer.files)];
      files = files.map((f,i)=>{ f._id = crypto.randomUUID(); f._p = 0; return f; });
      renderList();
    });
    file.addEventListener('change', e => {
      files = [...files, ...Array.from(e.target.files)].map(f=>{ f._id=crypto.randomUUID(); f._p=0; return f; });
      renderList();
    });

    async function upload() {
      send.disabled = true;
      const api = (apiBaseInput.value || DEFAULT_API_BASE).replace(/\/$/,'');

      const fd = new FormData();
      files.forEach(f => fd.append('files', f, f.name));

      try {
        const headers = {};
        if (API_KEY) headers['X-API-Key'] = API_KEY;
        const res = await fetch(api + '/api/upload', {
          method: 'POST', body: fd, headers
        });
        const data = await res.json();

        (data.results || []).forEach(r => {
          const target = files.find(f => f.name === r.filename);
          if (target) {
            target._p = 100;
            const m = document.getElementById('m_' + target._id);
            if (r.status === 'ingested') {
              m.innerHTML = `<span class=ok>已匯入</span>：新增 <b>${r.rows_added}</b> 列`;
            } else if (r.status === 'skipped') {
              m.innerHTML = `<span class=small>略過</span>：${r.message || '重複檔案'}`;
            } else {
              m.innerHTML = `<span class=err>失敗</span>：${r.message || ''}`;
            }
          }
        });
      } catch (e) {
        alert('上傳失敗：' + e.message);
      } finally {
        files = files.map(f => (f._p=100, f));
        renderList();
      }
    }

    async function downloadCsv(path, filename) {
      const api = (apiBaseInput.value || DEFAULT_API_BASE).replace(/\/$/,'');
      const headers = {};
      if (API_KEY) headers['X-API-Key'] = API_KEY;
      const res = await fetch(api + path, { headers });
      if (!res.ok) {
        const txt = await res.text();
        throw new Error('下載失敗：' + res.status + ' ' + txt);
      }
      const blob = await res.blob();
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = filename; a.style.display='none';
      document.body.appendChild(a); a.click(); a.remove();
      setTimeout(()=>URL.revokeObjectURL(url), 1000);
    }

    send.addEventListener('click', upload);
    dlData.addEventListener('click', () => downloadCsv('/api/export/measurements.csv', 'measurements.csv').catch(e=>alert(e.message)));
    dlSources.addEventListener('click', () => downloadCsv('/api/export/sources.csv', 'sources.csv').catch(e=>alert(e.message)));
  </script>
</body>
</html>
